<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="计算机图形学课程">
        
        <link rel="canonical" href="https://hashixuehua.github.io/geometry/06%20add%20camera/">
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>06 添加相机 - Computer Graphics</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">
        <link href="../css/style.css" rel="stylesheet">
        <link href="../css/admonition_fix.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-80323542-1', 'auto');
          ga('send', 'pageview');
        </script>
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">Computer Graphics</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">主页</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">目录 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../00%20about%20the%20course/">课程介绍</a>
</li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">基础篇</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../01%20setup%20the%20development%20environment/">01 开发环境搭建</a>
</li>

        
            
<li >
    <a href="../02%20hello%20Widget/">02 hello Widget</a>
</li>

        
            
<li >
    <a href="../03%20about%20OpenGL/">03 关于OpenGL</a>
</li>

        
            
<li >
    <a href="../04%20hello%20Triangle/">04 Hello Triangle</a>
</li>

        
            
<li >
    <a href="../05%20coordinate%20system/">05 坐标系统</a>
</li>

        
            
<li class="active">
    <a href="./">06 添加相机</a>
</li>

        
            
<li >
    <a href="../07%20principle%20of%20camera/">07 相机原理</a>
</li>

        
            
<li >
    <a href="../08%20use%20of%20vcpkg/">08 关于vcpkg的使用</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">场景搭建</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../09%20draw%20default%20work%20plane/">09 默认工作平面</a>
</li>

        
            
<li >
    <a href="../10%20add%20view%20cube/">10 添加视图立方体</a>
</li>

        
            
<li >
    <a href="../11%20add%20label%20of%20rotate%20center/">11 添加旋转中心标识</a>
</li>

        
            
<li >
    <a href="../12%20UI%20-%20add%20toolBar%20button/">12 UI：添加工具栏按钮</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">交互和绘制</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../13%20draw%20line%20and%20intro%20of%20framework%20system/">13 介绍框架体系并绘制线</a>
</li>

        
            
<li >
    <a href="../14%20draw%20curve/">14 其它类型线的绘制</a>
</li>

        
            
<li >
    <a href="../15%20draw%20image/">15 图片绘制</a>
</li>

        
            
<li >
    <a href="../16%20add%20snap%20label/">16 添加捕捉吸附标识</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">操作和设置</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../17%20add%20some%20components%20to%20scene/">17 添加一些组件</a>
</li>

        
            
<li >
    <a href="../18%20selected%20effect/">18 选中效果</a>
</li>

        
            
<li >
    <a href="../19%20set%20work%20plane/">19 设置工作平面</a>
</li>

        
            
<li >
    <a href="../20%20box%20select/">20 框选选择</a>
</li>

        
            
<li >
    <a href="../21%20copy/">21 复制</a>
</li>

        
            
<li >
    <a href="../22%20delete/">22 删除</a>
</li>

        
            
<li >
    <a href="../23%20show%20and%20hide%20controls/">23 显隐控制</a>
</li>

        
            
<li >
    <a href="../24%20layer%20management/">24 图层管理</a>
</li>

        
            
<li >
    <a href="../25%20wire%20frame%20mode/">25 线框模式</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">IO和其它</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../26%20about/">26 关于</a>
</li>

        
            
<li >
    <a href="../27%20file%20open%20and%20save/">27 文件打开和保存</a>
</li>

        
            
<li >
    <a href="../28%20other%20matters/">28 其它事项</a>
</li>

        
    </ul>
  </li>

                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../code_repo/">课程代码</a>
                </li>
            
            
            
                <li >
                    <a href="../intro/">CGLib</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> 搜索
                    </a>
                </li>
                <li >
                    <a rel="next" href="../05%20coordinate%20system/">
                        <i class="fa fa-arrow-left"></i> 上一节
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../07%20principle%20of%20camera/">
                        下一节 <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/hashixuehua/geometry">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
                <li>
                    <a href="https://mp.weixin.qq.com/s/KRMuyvCr70Nuw5ZW0HWasw">
                        公众号：哈市雪花
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#6camera">6.相机：引入Camera类</a></li>
        
            <li><a href="#61cglib">6.1.引入CGLib库</a></li>
        
            <li><a href="#62viewersetting">6.2.添加ViewerSetting类</a></li>
        
            <li><a href="#63viewerutils">6.3.添加ViewerUtils类</a></li>
        
            <li><a href="#64camerah">6.4.添加camera.h</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="6camera">6.相机：引入<code>Camera</code>类</h1>
<h2 id="61cglib">6.1.引入CGLib库</h2>
<ul>
<li>下载cglib：<a href="cglib.net/intro/">cglib.net</a></li>
<li>课程目录下新建<code>dependencies</code>文件夹，将cglib库放进去；注意在<code>.gitignore</code>文件中添加如下两行，以忽略依赖库文件；</li>
</ul>
<pre><code class="language-js">#dependencies
dependencies/
</code></pre>
<ul>
<li>在<code>src</code>目录下的<code>cmakelists</code>文件中的<code>find_package</code>后添加如下内容以使用CGLib库，</li>
</ul>
<pre><code class="language-js">#CGLib
set(CGLib &quot;${CMAKE_SOURCE_DIR}/../../dependencies/CGLib&quot;)
if(WIN32)
    include_directories(${CGLib}/include)testFunc/lib)
    link_directories(${CGLib}/bin/win64/Release)
    link_libraries(CGLib.lib)
endif()
</code></pre>
<ul>
<li>还有一件事，迟早得做，现在做了吧，把CGLib的dll和pdb文件拷贝到本项目的输出目录中（GLViewer.exe所在目录），默认是这里<code>out\build\x64-Debug\src</code>，如果没有更改的话。</li>
</ul>
<h2 id="62viewersetting">6.2.添加ViewerSetting类</h2>
<p>获取当前客户端<strong>设备像素比</strong>，并进行适配。</p>
<div class="admonition note">
<p class="admonition-title">补充：</p>
<p><code>设备像素比（devicePixelRatio）</code>：指当前显示设备的物理像素分辨率与CSS像素分辨率之比。这个比值可以理解为像素大小的比率：一个CSS像素的大小与一个物理像素的大小。简单来说，它告诉浏览器应使用多少屏幕实际像素来绘制单个CSS像素。</p>
</div>
<ul>
<li>在VS2022中切换到cmake项目视图，
<img src="../img/cad/image-20.png" alt="切换到cmake项目视图" title="切换到cmake项目视图" width="300" align="middle" style="display: block; margin-left: auto; margin-right: auto;"/></li>
</ul>
<figcaption style="text-align: center;">图：切换到cmake项目视图</figcaption>

<p><img src="../img/cad/image-21.png" alt="新建类" title="新建类" width="500" align="middle" style="display: block; margin-left: auto; margin-right: auto;"/></p>
<figcaption style="text-align: center;">图：新建类</figcaption>

<p>在弹出<code>建议的cmake脚本更改建议</code>窗体，我们取消即可，认真的同学应该明白个中缘由~
<img src="../img/cad/image-24.png" alt="取消对cmakelists的修改" title="取消对cmakelists的修改" width="400" align="middle" style="display: block; margin-left: auto; margin-right: auto;"/></p>
<figcaption style="text-align: center;">图：取消对cmakelists的修改</figcaption>

<p>如果项目视图的src下没有出现新添加的<code>ViewerSetting</code>代码文件，可能因为cmake配置需要更新，点击<code>配置缓存</code>或<code>删除缓存并重新配置</code>,
<img src="../img/cad/image-23.png" alt="配置cmake缓存" title="配置cmake缓存" width="300" align="middle" style="display: block; margin-left: auto; margin-right: auto;"/></p>
<figcaption style="text-align: center;">图：配置cmake缓存</figcaption>

<p>在<code>ViewerSetting.h</code>中添加代码，并记得在cpp文件中定义。这是因为不同客户端屏幕的缩放比例可能不同，需要进行适配，</p>
<pre><code class="language-c++">class ViewerSetting
{
public:
    //  适配不同客户端屏幕缩放比例
    static float devicePixelRatio;
};
</code></pre>
<p>我们需要读取当前客户端的这个值并记录：在main.cpp中添加如下代码，</p>
<pre><code class="language-c++">ViewerSetting::devicePixelRatio = QGuiApplication::primaryScreen()-&gt;devicePixelRatio();
</code></pre>
<pre><code class="language-c++">#include &lt;QApplication&gt;
#include &lt;QGuiApplication.h&gt;
#include &lt;QScreen.h&gt;

#include &quot;glwindow.h&quot;
#include &quot;ViewerSetting.h&quot;

int main(int argc, char *argv[])
{
    QApplication a(argc, argv);
    ViewerSetting::devicePixelRatio = QGuiApplication::primaryScreen()-&gt;devicePixelRatio();
    GLWindow w;
    w.show();
    return a.exec();
}
</code></pre>
<p>恭喜你，添加成功，但可能编译报错哦，我们使用了QT的Gui库，可能找不到，我们还需要更新下<code>cmakelists</code>文件对应位置添加如下脚本代码，</p>
<pre><code class="language-js">find_package(Qt6 REQUIRED COMPONENTS Gui)
target_link_libraries(GLViewer PRIVATE Qt6::Gui)
</code></pre>
<div class="admonition note">
<p class="admonition-title">注意：</p>
<p>记得编译一下，确保通过；</p>
</div>
<h2 id="63viewerutils">6.3.添加ViewerUtils类</h2>
<pre><code class="language-c++">//  ViewerUtils.h
#pragma once
#include &quot;CGUtils/CGUtils.h&quot;

using namespace CGUTILS;

class ViewerUtils
{
public:
    //  返回6个坐标轴（包含正负轴）中与dir最贴近的轴
    static Vector3f normalizeToAxis(const Vector3f&amp; dir, const Vector3f&amp; localX, const Vector3f&amp; localY, const Vector3f&amp; localZ);
};
</code></pre>
<pre><code class="language-c++">//  ViewerUtils.cpp
#include &quot;ViewerUtils.h&quot;

Vector3f ViewerUtils::normalizeToAxis(const Vector3f&amp; dir, const Vector3f&amp; localX, const Vector3f&amp; localY, const Vector3f&amp; localZ)
{
    double angleX = localX.Angle(dir);
    double angleY = localY.Angle(dir);
    double angleZ = localZ.Angle(dir);
    double rAng90 = PI / 2.0;
    bool bTX = angleX &gt; rAng90;
    bool bTY = angleY &gt; rAng90;
    bool bTZ = angleZ &gt; rAng90;
    if (bTX)
        angleX = PI - angleX;
    if (bTY)
        angleY = PI - angleY;
    if (bTZ)
        angleZ = PI - angleZ;

    if (angleX &lt; angleY &amp;&amp; angleX &lt; angleZ)
        return bTX ? -localX : localX;
    else if (angleY &lt; angleX &amp;&amp; angleY &lt; angleZ)
        return bTY ? -localY : localY;
    else// if (angleZ &lt; angleX &amp;&amp; angleZ &lt; angleY)
        return bTZ ? -localZ : localZ;
}
</code></pre>
<p>聪明的你已经发现，我们也成功使用了此前引入的<code>CGLib</code>库~</p>
<h2 id="64camerah">6.4.添加camera.h</h2>
<p>直接将<code>camera.h</code>文件复制到<code>src</code>下，或者用上述添加类的办法添加<code>camera.h</code>，然后复制代码进去。</p>
<p>确保编译通过，如果不通过就解决问题，直到通过，解决问题的办法很多，比如看本课程系列对应视频，教程文档，或者搜索，或者在群里问......</p>
<p>然后来到了本节课程的重头戏部分，使用camera吧~</p>
<ul>
<li>在<code>GLView</code>类中添加<code>Camera</code>成员字段，</li>
</ul>
<pre><code class="language-c++">Camera m_camera = Camera(this, QVector3D(0.0f, 6.0f, 10.0f));
</code></pre>
<ul>
<li>在<code>GLView.cpp</code>中<code>initializeGL</code>函数实现中添加如下代码，更新时间，</li>
</ul>
<pre><code class="language-c++">m_camera.lastFrame = QTime::currentTime().msecsSinceStartOfDay() / 1000.0;
</code></pre>
<ul>
<li>在<code>resizeGL</code>函数实现中添加如下代码，每次窗口尺寸变化都会更新，注意我们偷偷添加了<code>glViewport</code>调用，是为了让渲染管线正常工作，想起来了没？在处理为标准化设备坐标后，需要通过视口变换映射到屏幕像素上。</li>
</ul>
<pre><code class="language-c++">glViewport(0, 0, w, h);
m_camera.SCR_WIDTH = w;
m_camera.SCR_HEIGHT = h;
</code></pre>
<ul>
<li>我们来到了<code>paintGL</code>函数实现，首先添加如下代码，更新每个渲染循环的时间间隔<code>deltaTime</code>，</li>
</ul>
<pre><code class="language-c++">float currentFrame = QTime::currentTime().msecsSinceStartOfDay() / 1000.0;
m_camera.deltaTime = currentFrame - m_camera.lastFrame;
m_camera.lastFrame = currentFrame;
</code></pre>
<p>如果你这几天睡得足，那么你应该记得我们此前设置的<code>view-matrix</code>和<code>projection-matrix</code>为单位矩阵，那是临时的，赋予它意义的时刻到了，</p>
<pre><code class="language-c++">m_projectionMat.setToIdentity();
m_projectionMat.perspective(/*qDegreesToRadians*/(m_camera.Zoom), (float)m_camera.SCR_WIDTH / (float)m_camera.SCR_HEIGHT, 0.1f, 100.0f);

m_viewMat = m_camera.GetViewMatrix();
</code></pre>
<ul>
<li>嗯？应该是鼠标控制相机的运转呀，对的，我们一起来实现~
重写<code>event</code>函数，让<code>camera</code>捕获鼠标、键盘事件，嗯，至于怎么处理是它的事情了，</li>
</ul>
<pre><code class="language-c++">//  GLView.h
virtual bool event(QEvent* e);

//  GLView.cpp
bool GLView::event(QEvent* e)
{
    makeCurrent();

    if (m_camera.handle(e))
        update();

    doneCurrent();
    return QWidget::event(e);
}
</code></pre>
<p>如果正常的话，你可以通过鼠标操作相机，试着按住鼠标左键转动、按住鼠标右键移动、滚动鼠标滚轮，你会看到不同的效果~</p>
<p><img src="../img/cad/image-25.png" alt="相机工作" title="相机工作" width="500" align="middle" style="display: block; margin-left: auto; margin-right: auto;"/></p>
<figcaption style="text-align: center;">图：相机工作</figcaption>

<div class="admonition note">
<p class="admonition-title">思考：</p>
<p>为什么鼠标在三角形上左键旋转时，没有以此为旋转中心呢？</p>
</div>
<p>我们回顾下本节所作的事情，添加相机，并在GLView中去使用调用它，至于其它事情都是围绕这个目的展开的。</p>
<div class="admonition note">
<p class="admonition-title">提示：</p>
<p>作者在<code>视频课程</code>中对相机原理和实现有详细的讲解，包括原理和代码逻辑，欢迎观看。</p>
</div>

<div id="disqus_thread"></div>
<script>
    (function() {
        var d = document, s = d.createElement('script');

        s.src = '//cglib.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>请启用JavaScript以浏览<a href="https://disqus.com/?ref_noscript" rel="nofollow">Disqus评论。</a></noscript></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Powered by <a href="http://www.mkdocs.org/">MkDocs</a> and <a href="http://bootswatch.com/yeti/">Yeti</a></center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script src="../js/base.js"></script>
        <script src="../mathjax/MathJax.js?config=TeX-AMS_HTML"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">搜索</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            请在下面输入你要搜索的文本（仅支持英文）：
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="搜索..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>