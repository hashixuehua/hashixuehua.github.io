<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="计算机图形学课程">
        
        <link rel="canonical" href="https://hashixuehua.github.io/geometry/07%20principle%20of%20camera/">
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>07 相机原理 - Computer Graphics</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">
        <link href="../css/style.css" rel="stylesheet">
        <link href="../css/admonition_fix.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-80323542-1', 'auto');
          ga('send', 'pageview');
        </script>
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">Computer Graphics</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">主页</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">目录 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../00%20about%20the%20course/">课程介绍</a>
</li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">基础篇</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../01%20setup%20the%20development%20environment/">01 开发环境搭建</a>
</li>

        
            
<li >
    <a href="../02%20hello%20Widget/">02 hello Widget</a>
</li>

        
            
<li >
    <a href="../03%20about%20OpenGL/">03 关于OpenGL</a>
</li>

        
            
<li >
    <a href="../04%20hello%20Triangle/">04 Hello Triangle</a>
</li>

        
            
<li >
    <a href="../05%20coordinate%20system/">05 坐标系统</a>
</li>

        
            
<li >
    <a href="../06%20add%20camera/">06 添加相机</a>
</li>

        
            
<li class="active">
    <a href="./">07 相机原理</a>
</li>

        
            
<li >
    <a href="../08%20use%20of%20vcpkg/">08 关于vcpkg的使用</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">场景搭建</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../09%20draw%20default%20work%20plane/">09 默认工作平面</a>
</li>

        
            
<li >
    <a href="../10%20add%20view%20cube/">10 添加视图立方体</a>
</li>

        
            
<li >
    <a href="../11%20add%20label%20of%20rotate%20center/">11 添加旋转中心标识</a>
</li>

        
            
<li >
    <a href="../12%20UI%20-%20add%20toolBar%20button/">12 UI：添加工具栏按钮</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">交互和绘制</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../13%20draw%20line%20and%20intro%20of%20framework%20system/">13 介绍框架体系并绘制线</a>
</li>

        
            
<li >
    <a href="../14%20draw%20curve/">14 其它类型线的绘制</a>
</li>

        
            
<li >
    <a href="../15%20draw%20image/">15 图片绘制</a>
</li>

        
            
<li >
    <a href="../16%20add%20snap%20label/">16 添加捕捉吸附标识</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">操作和设置</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../17%20add%20some%20components%20to%20scene/">17 添加一些组件</a>
</li>

        
            
<li >
    <a href="../18%20selected%20effect/">18 选中效果</a>
</li>

        
            
<li >
    <a href="../19%20set%20work%20plane/">19 设置工作平面</a>
</li>

        
            
<li >
    <a href="../20%20box%20select/">20 框选选择</a>
</li>

        
            
<li >
    <a href="../21%20copy/">21 复制</a>
</li>

        
            
<li >
    <a href="../22%20delete/">22 删除</a>
</li>

        
            
<li >
    <a href="../23%20show%20and%20hide%20controls/">23 显隐控制</a>
</li>

        
            
<li >
    <a href="../24%20layer%20management/">24 图层管理</a>
</li>

        
            
<li >
    <a href="../25%20wire%20frame%20mode/">25 线框模式</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">IO和其它</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../26%20about/">26 关于</a>
</li>

        
            
<li >
    <a href="../27%20file%20open%20and%20save/">27 文件打开和保存</a>
</li>

        
            
<li >
    <a href="../28%20other%20matters/">28 其它事项</a>
</li>

        
    </ul>
  </li>

                    
                        
  <li class="dropdown-submenu">
    <a tabindex="-1" class="nav-title">高级效果</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../29%20object%20outlining/">29 外轮廓效果</a>
</li>

        
    </ul>
  </li>

                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../code_repo/">课程代码</a>
                </li>
            
            
            
                <li >
                    <a href="../intro/">CGLib</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> 搜索
                    </a>
                </li>
                <li >
                    <a rel="next" href="../06%20add%20camera/">
                        <i class="fa fa-arrow-left"></i> 上一节
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../08%20use%20of%20vcpkg/">
                        下一节 <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/hashixuehua/geometry">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
                <li>
                    <a href="https://mp.weixin.qq.com/s/KRMuyvCr70Nuw5ZW0HWasw">
                        公众号：哈市雪花
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#7camera">7.相机：Camera原理讲解</a></li>
        
            <li><a href="#71">7.1.概述和原理</a></li>
        
            <li><a href="#72">7.2.缩放</a></li>
        
            <li><a href="#73">7.3.移动</a></li>
        
            <li><a href="#74">7.4.旋转</a></li>
        
            <li><a href="#75">7.5.光标绘制</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="7camera">7.相机：<code>Camera</code>原理讲解</h1>
<div class="admonition note">
<p class="admonition-title">提示：</p>
<ul>
<li>在本文中作者采用了<code>glm</code>库相关的接口讲解，在课程代码中采用<code>QTMatrix</code>中类似的接口，但参数略有不同，详细可参照课程代码；</li>
<li>作者在<code>视频课程</code>中对相机原理和实现有详细的讲解，包括原理和代码逻辑，欢迎观看。</li>
</ul>
</div>
<h2 id="71">7.1.概述和原理</h2>
<p>​在显示交互中，往往需要进行移动、缩放、旋转等操作，便于多方位查看图形元素，可以通过把场景中的所有物体往相反方向变换的方式来模拟出摄像机，产生一种视角在变换的感觉，而不是场景在变换。</p>
<div class="admonition note">
<p class="admonition-title">补充：</p>
<ul>
<li>我们根据相机实时的位置姿态等参数计算出观察矩阵（<code>viewMatrix</code>），传递给渲染管线中的顶点着色器；而后经过渲染管线的处理，场景物体依次经过多种坐标变换和处理后，通过视口变换(<code>Viewport Transform</code>)投射到屏幕上；</li>
<li>场景中实际是没有相机的，我们通过虚拟出相机及参数，实时构造出<code>viewMatrix</code>及投影矩阵（<code>ProjectionMatrix</code>）传递给渲染管线，从而不断的变换和处理场景物体坐标，产生一种（通过操纵相机）在场景中进行运动的效果。</li>
</ul>
</div>
<p><img src="../img/cad/camera_axes.png" alt="观察空间示意" title="观察空间示意" width="600" align="middle" style="display: block; margin-left: auto; margin-right: auto;"/></p>
<figcaption style="text-align: center;">图：观察空间示意</figcaption>

<p>​定义一个摄像机，我们需要构造观察空间，包括观察位置、方向、右方向向量以及上方向向量。</p>
<p>观察空间的范围有限，将观察坐标变换为裁剪坐标的投影矩阵可以为两种不同的形式：正射投影矩阵(Orthographic Projection Matrix)或一个透视投影矩阵(Perspective Projection Matrix)，每种形式都定义了不同的平截头体。</p>
<p><img src="../img/cad/image-17.png" alt="透视投影示意" title="透视投影示意" width="400" align="middle" style="display: block; margin-left: auto; margin-right: auto;"/></p>
<figcaption style="text-align: center;">图：透视投影示意</figcaption>

<h2 id="72">7.2.缩放</h2>
<p>通过控制<code>fov</code>大小来实现缩放，<code>fov</code>会在透视投影时控制投影矩阵的缩放元素。</p>
<pre><code class="language-c++">projection = glm::perspective(glm::radians(fov), 800.0f / 600.0f, 0.1f, 100.0f);
</code></pre>
<p>具体可以监控鼠标滚轮来控制fov的变化。</p>
<h2 id="73">7.3.移动</h2>
<p>通过控制相机<code>cameraPos</code>来实现在场景中移动的效果，<code>cameraPos</code>会在观察空间转换矩阵中影响偏移元素。</p>
<pre><code class="language-c++">view = glm::lookAt(cameraPos, cameraPos + cameraFront, cameraUp);
</code></pre>
<p>具体可以通过监控鼠标右键移动或按键WASD触发来控制<code>cameraPos</code>的变化。</p>
<h2 id="74">7.4.旋转</h2>
<p>下图为欧拉角示意，一共有3种欧拉角：俯仰角(Pitch)、偏航角(Yaw)和滚转角(Roll)，对于我们的摄像机系统来说，我们只关心俯仰角和偏航角。</p>
<p><img src="../img/cad/camera_pitch_yaw_roll.png" alt="欧拉角" title="欧拉角" width="600" align="middle" style="display: block; margin-left: auto; margin-right: auto;"/></p>
<figcaption style="text-align: center;">图：欧拉角</figcaption>

<p>给定一个俯仰角和偏航角，我们可以把它们转换为一个代表新的方向向量的3D向量。</p>
<pre><code class="language-c++">// calculate the new Front vector
glm::vec3 front;
front.x = cos(glm::radians(Yaw)) * cos(glm::radians(Pitch));
front.y = sin(glm::radians(Pitch));
front.z = sin(glm::radians(Yaw)) * cos(glm::radians(Pitch));
Front = glm::normalize(front);
// also re-calculate the Right and Up vector
// normalize the vectors, because their length gets closer to 0 the more you look up or down which results
// in slower movement.
Right = glm::normalize(glm::cross(Front, WorldUp));  
Up = glm::normalize(glm::cross(Right, Front));
</code></pre>
<p>通过控制<code>pitch</code> 和<code>yaw</code>，进而控制<code>cameraPos</code>、<code>cameraFront</code>来实现相机旋转，模拟在场景中的旋转。根据旋转中心的不同可以分为绕原点旋转和绕指定点进行旋转。</p>
<h3 id="741">7.4.1.绕原点旋转</h3>
<p>绕原点旋转过程中，<code>cameraPos</code>与原点距离保持一致，而<code>cameraFront</code>和<code>cameraRight</code>在不断的更新，可以想象为一个飞机在球心和半径固定的球面擦边飞行。</p>
<p>当仅实现相机绕原点旋转时，容易求得<code>cameraPos</code>的值；当既支持绕原点旋转，也支持绕指定点旋转的情况下，绕原点旋转时的<code>cameraPos</code>计算方法同上。</p>
<h3 id="742">7.4.2.绕指定点旋转</h3>
<p>在实际操作中，往往需要绕指定点进行旋转，如绕当前选中的元素或绕鼠标悬浮点进行旋转。</p>
<p>和绕原点旋转类似，绕指定点<code>center</code>旋转的过程中，<code>cameraPos</code>与<code>center</code>距离保持一致，而由<code>cameraPos</code>指向<code>center</code>的向量<code>curFront</code>和对应的右向量<code>curRight</code>在不断的更新。</p>
<p>容易求得<code>center</code>到<code>cameraPos</code>的向量，再叠加<code>center</code>即可得到更新后的<code>cameraPos</code>。</p>
<p><img src="../img/cad/image-20230322224548010.png" alt="绕指定点旋转" title="绕指定点旋转" width="600" align="middle" style="display: block; margin-left: auto; margin-right: auto;"/></p>
<figcaption style="text-align: center;">图：绕指定点旋转</figcaption>

<pre><code class="language-c++">glm::vec3 rPt(Position.x - center.x, Position.y - center.y, Position.z - center.z);

//  计算position在right、front、up坐标系下的局部坐标
float lX = glm::dot(rPt, Right);
float lY = glm::dot(rPt, Front);
float lZ = glm::dot(rPt, Up);

// update Front, Right and Up Vectors using the updated Euler angles
updateCameraVectors();

Position = lX * Right + lY * Front + lZ * Up;
Position.x += center.x;
Position.y += center.y;
Position.z += center.z;
</code></pre>
<h2 id="75">7.5.光标绘制</h2>
<div class="admonition note">
<p class="admonition-title">提示：</p>
<p>最新内容请参考<code>11 添加旋转中心标识</code>和<code>16 Add snap label</code>章节。</p>
</div>
<p>当实现绕鼠标悬浮点进行旋转时，当前光标位置尤为重要，可以直观的看到到旋转中心位置。</p>
<p>鼠标光标绘制方法较多，如在OpenGL渲染管线中进行绘制，或用SVG等其他库进行绘制。</p>
<p>在OpenGL中绘制时，可以定义单独的<code>VBO</code>、<code>EBO</code>、<code>VAO</code>，在每个渲染循环中根据当前鼠标位置更新光标偏移。</p>
<pre><code class="language-c++">//  draw mouse
glm::mat4 modelMouse = glm::mat4(1.0f);
modelMouse = glm::translate(modelMouse, { ourModel-&gt;mousePos.X, ourModel-&gt;mousePos.Y, ourModel-&gt;mousePos.Z }); // translate it down so it's at the center of the scene
//modelMouse = glm::scale(modelMouse, glm::vec3(1.0f, 1.0f, 1.0f)); // it's a bit too big for our scene, so scale it down
ourShader.setMat4(&quot;model&quot;, modelMouse);
ourModel-&gt;DrawMouse(ourShader);
</code></pre>
<pre><code class="language-c++">void DrawMouse(Shader&amp; shader)
    {
        shader.setVec3(&quot;objectColor&quot;, 1.0f, 0.5f, 0.f);
        glLineWidth(2.0f);

        glBindVertexArray(VAOMouse);
        glDrawElements(GL_LINES, static_cast&lt;unsigned int&gt;(indices.size()), GL_UNSIGNED_INT, 0);

        glBindVertexArray(0);

        // always good practice to set everything back to defaults once configured.
        glActiveTexture(GL_TEXTURE0);
    }
</code></pre>
<div class="admonition note">
<p class="admonition-title">补充：</p>
<p>相机议题中常见的问题有<code>相机裁剪</code>等问题，本文不对此进行深入的探讨，感兴趣的读者可自行搜索和研究。</p>
</div>

<div id="disqus_thread"></div>
<script>
    (function() {
        var d = document, s = d.createElement('script');

        s.src = '//cglib.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>请启用JavaScript以浏览<a href="https://disqus.com/?ref_noscript" rel="nofollow">Disqus评论。</a></noscript></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Powered by <a href="http://www.mkdocs.org/">MkDocs</a> and <a href="http://bootswatch.com/yeti/">Yeti</a></center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script src="../js/base.js"></script>
        <script src="../mathjax/MathJax.js?config=TeX-AMS_HTML"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">搜索</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            请在下面输入你要搜索的文本（仅支持英文）：
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="搜索..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>